import os
import logging
import asyncio
from dotenv import load_dotenv
from telethon import TelegramClient, events
from telethon.sessions import StringSession
import nest_asyncio

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')
log = logging.getLogger("relay-bot")

nest_asyncio.apply()
load_dotenv()

API_ID = int(os.getenv("API_ID"))
API_HASH = os.getenv("API_HASH")
STRING_SESSION = os.getenv("STRING_SESSION")
TARGET_CHAT_ID = int(os.getenv("TARGET_CHAT_ID"))

# –ñ—ë—Å—Ç–∫–æ —É–∫–∞–∑—ã–≤–∞–µ–º ID –∫–∞–Ω–∞–ª–∞ @TOPOVHELP
SOURCE_CHANNEL_ID = -1002050105527

# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
CATEGORIES = {
    "411 üè°": [
        '411', '–¥–∞—á–∞ –ö–æ–≤–∞–ª–µ–≤—Å–∫–æ–≥–æ', '—á–µ—Ä–Ω–æ–º–æ—Ä–∫–∞', '–æ—á–∏—Å—Ç–Ω', '–≥–æ–≥–æ–ª', '–¥–µ–º—á–µ–Ω–∫', '–æ—Ç–≤–∞–∂–Ω', '–æ—Ä–µ—Ö–æ–≤', '–∞–≤–∏–Ω—å–µ–Ω', '–¥–æ–ª–≥', '–∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä—Å–∫', '–∞–≤–∏–Ω—å—ë–Ω'
    ],
    "–ö–∞–¥–æ—Ä üíº üèãÔ∏è": [
        '–∞–∫–≤–∞—Ä–µ–ª—å 2', '2 –∞–∫–≤–∞—Ä–µ–ª—å', '–º–∞—Ä—à–∞–ª —Å–∏—Ç–∏', '–∫–∞–¥–æ—Ä', '–∂–µ–º—á—É–∂–∏–Ω', '–º–∞—Ä—à–∞–ª–∞ –∂—É–∫–æ–≤–∞', '–Ω–µ–±–µ—Å–Ω'
    ],
    "–¢–∞–∏—Ä–æ–≤–∞ üåÉ": [
        '–ª—é—Å—Ç–¥–æ—Ä—Ñ—Å–∫', '–≥–ª—É—à–∫–æ', '–≤–∏–ª—å—è–º—Å', '—Ç–∞–∏—Ä–æ–≤', '–∏–ª—å—Ñ–∞ –∏ –ø–µ—Ç—Ä–æ–≤–∞', '–≥–ª–æ–¥–∞', '—Å–∏—Ç–∏–∫', '—Å–∏—Ç–∏—Ü–µ–Ω—Ç—Ä', '—Å–∏—Ç–∏ —Ü–µ–Ω—Ç—Ä', '–∫–æ—Ä–æ–ª–µ–≤', '–∫–ª—é—à–∫', '–ø—Ä–∏–≤–∞–ª', '—é–∂–Ω', '–∫–∏–µ–≤—Å–∫', '–ª—å–≤–æ–≤—Å–∫', '–ª–µ–≤–∏—Ç–∞–Ω', '–∫–æ—Å—Ç–∞–Ω–¥', '—Ä–∏—Ñ'
    ],
    "üå≥ –ü–∞—Ä–∫ –ì–æ—Ä—å–∫–æ–≥–æ": [
        '–≥–æ—Ä—å–∫–æ–≥', '–∏–Ω–≥–ª–µ–∑', '–≤–∞—Ä–Ω–µ–Ω—Å–∫', '–∫–æ—Å–º–æ–Ω–∞–≤—Ç', '—Ç–µ—Ä–µ—à–∫–æ–≤', '–≥–µ–Ω–µ—Ä–∞–ª–∞ –ø–µ—Ç—Ä–æ–≤–∞', '–≥–∞–π–¥–∞—Ä'
    ],
    "–†—ã–±–∞–ª–∫–∞ üé£ —á–µ—Ä–µ–∑ 2 —Å—Ç–æ–ª–±–∞": [
        '–º–∞—è–∫–∏', '–¥–≤–∞ —Å—Ç–æ–ª–±–∞', '2 —Å—Ç–æ–ª–±–∞', '–∞–≤–∞–Ω–≥–∞—Ä–¥', '—Å—É—Ö–æ–π –ª–∏–º–∞–Ω', '–¥–∞–ª—å–Ω–∏–∫', '—Ö–ª–µ–±–æ–¥–∞—Ä—Å–∫', '—Ä–∞—Å—Å–µ–ª–µ–Ω–µ—Ü', '–º–∏—Ä–Ω', '–±–µ–ª—è–µ–≤–∫', '—Ä–µ–Ω–∏', '–∏–∑–º–∞–∏–ª'
    ],
    "–†—ã–±–∞–ª–∫–∞ üé£ –ø–µ—Ç—Ä–æ–¥–æ–ª–∏–Ω–∞": [
        '–ø–µ—Ä–µ–ø—Ä–∞–≤', '–±–∞—Ä–∞–±–æ–π', '–º–∞–ª–æ–¥–æ–ª–∏–Ω—Å–∫', '–≤–µ–ª–∏–∫–æ–¥–æ–ª–∏–Ω—Å–∫', '–º–∞–ª–∞—è –¥–æ–ª–∏–Ω', '–±–æ–ª—å—à–∞—è –¥–æ–ª–∏–Ω', '–ø—Ä–∏–ª–∏–º–∞–Ω—Å–∫', '–Ω–æ–≤–∞—è –¥–æ–ª–∏–Ω', '–¥–æ–±—Ä–æ–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∫', '–Ω–æ–≤–æ–≥–æ—Ä–æ–¥–∫–æ–≤–∫', '–º–∞—Ä—å—è–Ω–æ–≤–∫', '–π–æ—Å–∏–ø–æ–≤–∫', '–ø–µ—Ç—Ä–æ–¥–æ–ª–∏–Ω—Å–∫', '–ø–µ—Ç—Ä–æ–¥–æ–ª–∏–Ω'
    ],
    "üëÆ –í–Ω–∏–º–∞–Ω–∏–µ!": [
        '–º–µ–Ω—Ç', '—Ç–æ—Ä–º–æ–∑', '–ø–ª–∞–Ω—à–µ—Ç', '–ª—é—Å—Ç—Ä', '–±–ø', '–±–ª–æ–∫–ø–æ—Å—Ç', '–±–ª–æ–∫-–ø–æ—Å—Ç', '–ª–µ–¥–µ–Ω—Ü', '–ø–∞—Ç—Ä—É–ª—å', '–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤'
    ],
    "üö® –ë–ü": [
        '–±–ø', '–±–ª–æ–∫–ø–æ—Å—Ç', '–±–ª–æ–∫-–ø–æ—Å—Ç'
    ],
    "‚õ≤Ô∏è –§–æ–Ω—Ç–∞–Ω": [
        '—Ñ–æ–Ω—Ç–∞–Ω', '—Ñ–∞–Ω—Ç–∞–Ω', '–≥–æ—Ä—å–∫–æ–≥', '–±—É—Ö–∏–Ω', '—Ç–æ–ª–±—É—Ö–∏–Ω', '—Ç–∞–ª–±—É—Ö–∏–Ω', '–ø–∞—Ä–∫ –ø–æ–±–µ–¥', '–ø–æ–±–µ–¥', '–∞–¥–º–∏—Ä–∞–ª—å—Å–∫', '–≥–æ–≤–æ—Ä–æ–≤', '—Å–µ–≥–µ–¥—Å–∫'
    ],
    "–ñ–î üöâ": [
        r'\b–∂–¥\b', '—Å—Ä–µ–¥–Ω–µ—Ñ–æ–Ω—Ç–∞–Ω—Å–∫', '–≤–æ–¥–æ–ø—Ä–æ–≤–æ–¥–Ω'
    ]
}


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
def detect_category(text: str) -> str | None:
    text_lower = text.lower()
    for category, keywords in CATEGORIES.items():
        for keyword in keywords:
            if keyword in text_lower:
                return category
    return None

# Telegram –∫–ª–∏–µ–Ω—Ç
client = TelegramClient(StringSession(STRING_SESSION), API_ID, API_HASH)

async def setup():
    await client.start()
    log.info("‚úÖ –ö–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω")
    log.info(f"üì° –°–ª—É—à–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∞–Ω–∞–ª ID: {SOURCE_CHANNEL_ID}")
    log.info("üü¢ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ–∂–∏–¥–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è...")

    @client.on(events.NewMessage)
    async def handler(event):
        if event.chat_id != SOURCE_CHANNEL_ID:
            return  # –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Å—ë, –∫—Ä–æ–º–µ –Ω—É–∂–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞

        text = event.message.message
        if not text:
            return  # –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

        category = detect_category(text)
        if not category:
            log.info("üîï –ü—Ä–æ–ø—É—â–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
            return  # –µ—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

        final_text = f"{category}:\n\n{text}"
        await client.send_message(TARGET_CHAT_ID, final_text)
        log.info(f"üì§ –ü–µ—Ä–µ—Å–ª–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ {TARGET_CHAT_ID} —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π: {category}")

    await client.run_until_disconnected()

# –ó–∞–ø—É—Å–∫
loop = asyncio.get_event_loop()
loop.run_until_complete(setup())
